<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æœ€å°‘éŒ¢å¹£ä»˜æ¬¾å°éŠæˆ²</title>

  <style>
    @font-face {
      font-family: "BpmfZihiKaiStd";
      src: url("BpmfZihiKaiStd-Regular.ttf") format("truetype");
      font-weight: normal;
      font-style: normal;
    }

    * {
      box-sizing: border-box;
      font-family: "BpmfZihiKaiStd", "Noto Sans TC", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 12px;
      background: #f3f4f6;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;

      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      font-size: 22px;
    }

    .game-container {
      width: min(1240px, calc(100vw - 24px));
      height: min(680px, calc(100vh - 24px));
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      display: flex;
      overflow: hidden;
      position: relative;
    }

    /* ===== å·¦æ¬„ï¼ˆé¡Œç›®å€ä¸Šä¸‹ç½®ä¸­ï¼‰ ===== */
    .left-panel {
      width: 30%;
      padding: 20px 26px 16px;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      background: #f9fafb;
      min-width: 280px;
      gap: 10px;
    }

    .question-number {
      font-size: 20px;
      color: #6b7280;
      text-align: center;
      margin-bottom: 2px;
    }

    .progress-info {
      font-size: 20px;
      color: #6b7280;
      text-align: center;
      padding-bottom: 10px;
      border-bottom: 1px dashed #e5e7eb;
    }

    .left-middle {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 12px;
      padding: 6px 0;
      min-height: 0;
    }

    .product-image {
      border-radius: 12px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 10px;
      height: clamp(170px, 30vh, 250px);
    }

    .product-emoji { font-size: 92px; line-height: 1; }

    .question-header { text-align: center; }

    .price-display {
      font-size: 46px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 4px;
    }

    .price-display span.unit {
      font-size: 26px;
      margin-left: 4px;
      color: #4b5563;
    }

    .product-name { font-size: 26px; color:#374151; }

    .left-bottom {
      display: flex;
      justify-content: center;
      padding-top: 6px;
    }

    .btn-help {
      border: none;
      padding: 12px 22px;
      border-radius: 999px;
      background: #111827;
      color: #ffffff;
      font-size: 20px;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.12s ease, background 0.12s ease;
      box-shadow: 0 8px 18px rgba(0,0,0,0.18);
    }
    .btn-help:hover { background:#0b1220; box-shadow:0 12px 24px rgba(0,0,0,0.22); transform:translateY(-1px); }
    .btn-help:active { transform:translateY(0px); box-shadow:0 8px 18px rgba(0,0,0,0.18); }

    /* ===== å³æ¬„ ===== */
    .right-panel {
      width: 70%;
      padding: 22px;
      position: relative;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .options-grid {
      width: 100%;
      height: 100%;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 18px;
      align-items: stretch;
      justify-items: stretch;
    }

    .option-card {
      background: #f9fafb;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      padding: 14px 14px 12px;
      display: flex;
      flex-direction: column;
      cursor: pointer;
      transition: box-shadow 0.12s ease, border-color 0.12s ease, background 0.12s ease;
    }

    .option-card:hover {
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      border-color: #3b82f6;
      background: #eff6ff;
    }

    .option-card.disabled { cursor: default; opacity: 0.6; box-shadow: none; }

    .option-title { font-size: 22px; font-weight: 500; color:#374151; margin-bottom:8px; text-align:center; }

    .option-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 8px;
      align-items: center;
    }

    .money-line { display:flex; align-items:center; justify-content:flex-start; width:max-content; margin:0 auto; }

    .note-icon {
      min-width: 128px;
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      text-align: center;
      font-size: 20px;
      margin-right: 12px;
      background: #ffffff;
      line-height: 1.2;
    }

    .note-1000 { background:#dbeafe; border-color:#93c5fd; }
    .note-100  { background:#fecaca; border-color:#f87171; }
    .note-10   { background:#e5e7eb; border-color:#9ca3af; }
    .note-1    { background:#fed7aa; border-color:#f97316; }

    .note-multiplier { display:flex; align-items:center; min-width: 90px; font-size: 20px; color:#374151; }
    .note-multiplier strong { font-weight: 700; margin-left: 4px; }

    /* ===== å›é¥‹ overlay ===== */
    .feedback-overlay {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease;
      z-index: 10;
    }
    .feedback-overlay.visible { opacity:1; pointer-events:auto; }

    .feedback-circle {
      min-width: 340px;
      max-width: 460px;
      border-radius: 24px;
      background: #ffffff;
      padding: 24px 30px 26px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      animation: pop 0.25s ease-out;
      text-align: center;
    }
    .feedback-icon {
      width: 94px; height: 94px;
      border-radius: 999px;
      border: 3px solid currentColor;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 54px;
      margin-bottom: 14px;
    }
    .feedback-text { font-size: 30px; font-weight: 700; color:#111827; margin-bottom: 10px; }
    .feedback-text-sub { font-size: 22px; color:#4b5563; line-height: 1.5; }

    @keyframes pop { from { transform: scale(0.86); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    /* ===== çµæŸç•«é¢ ===== */
    .end-screen {
      position: absolute;
      inset: 0;
      background: rgba(249, 250, 251, 0.98);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 20;
      text-align: center;
      padding: 20px;
    }
    .end-screen.visible { display:flex; }

    .end-title { font-size: 40px; font-weight: 800; margin-bottom: 14px; color:#111827; }
    .end-subtitle { font-size: 24px; color:#4b5563; margin-bottom: 22px; line-height: 1.5; }
    .end-score { font-size: 28px; color:#1f2937; margin-bottom: 28px; font-weight: 700; }

    .btn-restart {
      border: none;
      padding: 14px 32px;
      border-radius: 999px;
      background: #3b82f6;
      color: #ffffff;
      font-size: 22px;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.1s ease;
      box-shadow: 0 6px 14px rgba(37, 99, 235, 0.4);
    }
    .btn-restart:hover { background:#2563eb; transform:translateY(-1px); box-shadow:0 10px 20px rgba(37, 99, 235, 0.5); }
    .btn-restart:active { transform:translateY(0); box-shadow:0 4px 10px rgba(37, 99, 235, 0.4); }

    /* ===== æ“ä½œèªªæ˜ï¼ˆæ”¹æˆå¯æ»¾å‹•ï¼‰ ===== */
    .guide-overlay {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 14px;
    }
    .guide-overlay.visible { display:flex; }

    .guide-modal {
      width: min(1180px, 96vw);
      height: min(720px, 92vh);
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.32);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .guide-header {
      padding: 12px 14px;
      border-bottom: 1px solid #e5e7eb;
      background: #f9fafb;
      display: grid;
      grid-template-columns: 90px 1fr 90px;
      align-items: center;
      column-gap: 10px;
    }

    .guide-indicator { font-size: 18px; font-weight: 900; color:#6b7280; justify-self: start; }

    .guide-header-title {
      justify-self: center;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 22px;
      border-radius: 14px;
      border: 2px solid #111827;
      background: #ffffff;
      font-size: 30px;
      font-weight: 900;
      color: #111827;
      text-align: center;
      white-space: nowrap;
    }

    .guide-close {
      justify-self: end;
      width: 52px;
      height: 46px;
      border-radius: 14px;
      border: none;
      background: #111827;
      color: #ffffff;
      cursor: pointer;
      font-size: 22px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.08s ease, background 0.12s ease;
    }
    .guide-close:hover { background:#0b1220; transform:translateY(-1px); }
    .guide-close:active { transform:translateY(0px); }

    /* âœ… é—œéµï¼šå…è¨±æ»¾å‹• */
    .guide-body {
      flex: 1;
      padding: 16px 18px;
      overflow-y: auto;   /* âœ… å¯æ»¾è¼ªä¸Šä¸‹æ‹‰ */
      overflow-x: hidden;
      background: #ffffff;
    }

    .guide-inner {
      width: 100%;
      max-width: 1060px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
    }

    .guide-page-title {
      font-size: 34px;
      font-weight: 900;
      color: #111827;
      text-align: center;
      margin: 0;
    }

    .guide-text {
      font-size: 24px;
      color: #374151;
      line-height: 1.5;
      text-align: center;
      width: 100%;
      margin: 0;
    }

    /* âœ… ç¬¬ä¸€é ï¼šä¸Šä¸‹ç½®ä¸­ï¼ˆå°±ç®— guide-body å¯æ»¾å‹•ä¹Ÿèƒ½ç½®ä¸­ï¼‰ */
    .center-page {
      min-height: calc(100% - 4px);
      justify-content: center;
    }

    /* demo */
    .demo-wrap { width: 100%; display:flex; justify-content:center; }

    .demo {
      width: min(980px, 96%);
      aspect-ratio: 1080 / 560;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      box-shadow: 0 10px 22px rgba(0,0,0,0.10);
      display: flex;
      position: relative;
      overflow: hidden;
    }

    .demo-left {
      width: 30%;
      background: #f9fafb;
      border-right: 1px solid #e5e7eb;
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .demo-q {
      text-align: center;
      font-size: 16px;
      color: #6b7280;
      font-weight: 900;
      margin-top: 2px;
    }

    .demo-progress {
      text-align: center;
      font-size: 16px;
      color: #6b7280;
      padding-bottom: 10px;
      border-bottom: 1px dashed #e5e7eb;
      font-weight: 900;
    }

    .demo-product-image {
      border-radius: 12px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 10px;
      flex: 1;
      min-height: 120px;
    }
    .demo-emoji { font-size: 60px; line-height: 1; }

    .demo-question-header { text-align: center; }
    .demo-price { font-size: 22px; font-weight: 900; color:#111827; margin-top: 4px; }
    .demo-name  { font-size: 18px; font-weight: 800; color:#374151; margin-top: 2px; }

    .demo-help {
      text-align: center;
      font-size: 14px;
      color: #ffffff;
      background: #111827;
      border-radius: 999px;
      padding: 9px 10px;
      width: 84%;
      margin: 6px auto 0;
      font-weight: 900;
    }

    .demo-right {
      width: 70%;
      padding: 14px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 12px;
      background: #ffffff;
    }

    .demo-card {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      display: flex;
      flex-direction: column;
      padding: 10px;
      gap: 8px;
    }

    .demo-card-title {
      font-size: 14px;
      color: #374151;
      text-align: center;
      font-weight: 900;
    }

    .demo-lines {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 7px;
      align-items: center;
    }

    .demo-line { display:flex; align-items:center; gap: 8px; }

    .demo-note {
      width: 62px;
      height: 22px;
      border-radius: 7px;
      border: 1px solid #d1d5db;
      background: #fff;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
    }

    .demo-note.b { background: #dbeafe; border-color: #93c5fd; }
    .demo-note.r { background: #fecaca; border-color: #f87171; }
    .demo-note.s { background: #e5e7eb; border-color: #9ca3af; }
    .demo-note.c { background: #fed7aa; border-color: #f97316; }

    .demo-x { font-size: 12px; color:#374151; width: 34px; font-weight: 900; }

    /* callout */
    .callout-box {
      position: absolute;
      border: 4px solid #2563eb;
      border-radius: 14px;
      box-shadow: 0 10px 22px rgba(37,99,235,0.25);
      pointer-events: none;
      z-index: 5;
      background: transparent;
    }

    .callout-label {
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      background: #2563eb;
      color: #ffffff;
      font-weight: 900;
      font-size: 14px;
      padding: 6px 10px;
      border-radius: 999px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
      white-space: nowrap;
      max-width: calc(100% - 20px);
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .feedback-samples {
      width: min(980px, 96%);
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 6px;
    }

    .feedback-sample {
      border-radius: 18px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      box-shadow: 0 10px 22px rgba(0,0,0,0.10);
      padding: 16px 16px 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      text-align: center;
    }

    .feedback-sample .icon {
      width: 78px;
      height: 78px;
      border-radius: 999px;
      border: 3px solid currentColor;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 44px;
    }

    .feedback-sample .title { font-size: 28px; font-weight: 900; color:#111827; }
    .feedback-sample .sub { font-size: 20px; color:#4b5563; line-height: 1.55; }

    .guide-footer {
      padding: 12px 16px;
      border-top: 1px solid #e5e7eb;
      background: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .guide-btn {
      border: none;
      padding: 12px 18px;
      border-radius: 999px;
      background: #3b82f6;
      color: #ffffff;
      font-size: 20px;
      font-weight: 900;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.35);
      transition: transform 0.08s ease, background 0.12s ease, box-shadow 0.12s ease;
    }
    .guide-btn:hover { background:#2563eb; transform:translateY(-1px); box-shadow:0 12px 22px rgba(37, 99, 235, 0.42); }
    .guide-btn:active { transform:translateY(0px); }

    .guide-btn.secondary { background:#111827; box-shadow:0 8px 18px rgba(0,0,0,0.22); }
    .guide-btn.secondary:hover { background:#0b1220; box-shadow:0 12px 22px rgba(0,0,0,0.28); }

    @media (max-width: 980px) {
      body { padding: 10px; }
      .game-container {
        width: calc(100vw - 20px);
        height: calc(100vh - 20px);
        flex-direction: column;
      }
      .left-panel, .right-panel { width: 100%; }
      .left-panel { border-right: none; border-bottom: 1px solid #e5e7eb; }
      .feedback-samples { grid-template-columns: 1fr; }
      .guide-modal { width: 96vw; height: 92vh; }
      .product-image { height: clamp(150px, 24vh, 220px); }
    }
  </style>
</head>

<body>
  <div class="game-container">
    <!-- å·¦æ¬„ -->
    <div class="left-panel">
      <div class="question-number" id="questionNumber"></div>
      <div class="progress-info" id="progressInfo"></div>

      <div class="left-middle">
        <div class="product-image" id="productImage">
          <div class="product-emoji" id="productEmoji">ğŸ§¸</div>
        </div>

        <div class="question-header">
          <div class="price-display" id="priceDisplay"></div>
          <div class="product-name" id="productName"></div>
        </div>
      </div>

      <div class="left-bottom">
        <button class="btn-help" id="helpBtn">æ“ä½œèªªæ˜</button>
      </div>
    </div>

    <!-- å³æ¬„ -->
    <div class="right-panel">
      <div class="options-grid" id="optionsGrid"></div>

      <div class="feedback-overlay" id="feedbackOverlay">
        <div class="feedback-circle">
          <div class="feedback-icon" id="feedbackIcon">âœ“</div>
          <div class="feedback-text" id="feedbackText"></div>
          <div class="feedback-text-sub" id="feedbackSubText"></div>
        </div>
      </div>

      <div class="end-screen" id="endScreen">
        <div class="end-title" id="endTitle"></div>
        <div class="end-subtitle" id="endSubtitle"></div>
        <div class="end-score" id="endScore"></div>
        <button class="btn-restart" id="restartBtn"></button>
      </div>
    </div>

    <!-- æ“ä½œèªªæ˜ -->
    <div class="guide-overlay" id="guideOverlay" aria-hidden="true">
      <div class="guide-modal" role="dialog" aria-modal="true" aria-label="æ“ä½œèªªæ˜">
        <div class="guide-header">
          <div class="guide-indicator" id="guideIndicator">1 / 4</div>
          <div class="guide-header-title">æ“ä½œèªªæ˜</div>
          <button class="guide-close" id="guideCloseBtn" aria-label="é—œé–‰">âœ•</button>
        </div>

        <div class="guide-body" id="guideBody"></div>

        <div class="guide-footer">
          <button class="guide-btn secondary" id="guidePrevBtn">ä¸Šä¸€é </button>
          <button class="guide-btn" id="guideNextBtn">ä¸‹ä¸€é </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    function shuffle(array) {
      const arr = array.slice();
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function formatPrice(price) { return price.toString(); }

    function punctToBreaks(text) {
      return text
        .replace(/([ã€‚ï¼ï¼Ÿï¼›ï¼š])/g, "$1<br>")
        .replace(/([ï¼Œã€])/g, "$1<br>")
        .replace(/<br>\s*<br>/g, "<br>");
    }

    /* ========= é¡Œåº« ========= */
   const questionsPool = [
  {
    price: 2321, name: "ç©æœ¨çµ„åˆ", emoji: "ğŸ§±",
    options: [
      [{ denom: 1000, count: 2 }, { denom: 100, count: 3 }, { denom: 10, count: 2 }, { denom: 1, count: 1 }],
      [{ denom: 100, count: 23 }, { denom: 10, count: 2 }, { denom: 1, count: 1 }],
      [{ denom: 1000, count: 2 }, { denom: 10, count: 32 }, { denom: 1, count: 1 }],
      [{ denom: 1, count: 2321 }]
    ],
    correctIndex: 0
  },
  {
    price: 3152, name: "å°ç†Šç©å¶", emoji: "ğŸ§¸",
    options: [
      [{ denom: 1000, count: 3 }, { denom: 100, count: 1 }, { denom: 10, count: 5 }, { denom: 1, count: 2 }],
      [{ denom: 100, count: 31 }, { denom: 1, count: 52 }],
      [{ denom: 1, count: 3152 }],
      [{ denom: 1000, count: 3 }, { denom: 10, count: 15 }, { denom: 1, count: 2 }]
    ],
    correctIndex: 0
  },
  {
    price: 4800, name: "é™æ§æ©Ÿå™¨äºº", emoji: "ğŸ¤–",
    options: [
      [{ denom: 1000, count: 4 }, { denom: 100, count: 8 }, { denom: 10, count: 0 }, { denom: 1, count: 0 }],
      [{ denom: 1000, count: 0 }, { denom: 100, count: 48 }, { denom: 10, count: 0 }, { denom: 1, count: 0 }],
      [{ denom: 1000, count: 0 }, { denom: 100, count: 0 }, { denom: 10, count: 480 }, { denom: 1, count: 0 }],
      [{ denom: 1000, count: 3 }, { denom: 100, count: 18 }, { denom: 10, count: 0 }, { denom: 1, count: 0 }]
    ],
    correctIndex: 0
  },
  {
    price: 9999, name: "é«˜éšéŠæˆ²ä¸»æ©Ÿ", emoji: "ğŸ®",
    options: [
      [{ denom: 1000, count: 9 }, { denom: 100, count: 9 }, { denom: 10, count: 9 }, { denom: 1, count: 9 }],
      [{ denom: 1000, count: 0 }, { denom: 100, count: 99 }, { denom: 10, count: 9 }, { denom: 1, count: 9 }],
      [{ denom: 1000, count: 9 }, { denom: 100, count: 0 }, { denom: 10, count: 99 }, { denom: 1, count: 9 }],
      [{ denom: 1000, count: 0 }, { denom: 100, count: 0 }, { denom: 10, count: 0 }, { denom: 1, count: 9999 }]
    ],
    correctIndex: 0
  },

  // ====== æ–°å¢ 6 é¡Œï¼ˆå…± 10 é¡Œï¼‰ ======

  {
    price: 2745, name: "å½©è‰²ç•«ç­†çµ„", emoji: "ğŸ–ï¸",
    options: [
      [{ denom: 1000, count: 2 }, { denom: 100, count: 7 }, { denom: 10, count: 4 }, { denom: 1, count: 5 }], // æ­£ç¢º
      [{ denom: 100, count: 27 }, { denom: 10, count: 4 }, { denom: 1, count: 5 }],
      [{ denom: 10, count: 274 }, { denom: 1, count: 5 }],
      [{ denom: 1000, count: 1 }, { denom: 100, count: 17 }, { denom: 10, count: 4 }, { denom: 1, count: 5 }]
    ],
    correctIndex: 0
  },
  {
    price: 5609, name: "é‹å‹•æ°´å£º", emoji: "ğŸ¥¤",
    options: [
      [{ denom: 1000, count: 5 }, { denom: 100, count: 6 }, { denom: 10, count: 0 }, { denom: 1, count: 9 }], // æ­£ç¢º
      [{ denom: 100, count: 56 }, { denom: 1, count: 9 }],
      [{ denom: 10, count: 560 }, { denom: 1, count: 9 }],
      [{ denom: 1000, count: 4 }, { denom: 100, count: 16 }, { denom: 10, count: 0 }, { denom: 1, count: 9 }]
    ],
    correctIndex: 0
  },
  {
    price: 7018, name: "æ•…äº‹æ›¸å¥—çµ„", emoji: "ğŸ“š",
    options: [
      [{ denom: 1000, count: 7 }, { denom: 100, count: 0 }, { denom: 10, count: 1 }, { denom: 1, count: 8 }], // æ­£ç¢º
      [{ denom: 100, count: 70 }, { denom: 10, count: 1 }, { denom: 1, count: 8 }],
      [{ denom: 10, count: 701 }, { denom: 1, count: 8 }],
      [{ denom: 1000, count: 6 }, { denom: 100, count: 10 }, { denom: 10, count: 1 }, { denom: 1, count: 8 }]
    ],
    correctIndex: 0
  },
  {
    price: 8420, name: "æ‹¼åœ–å¤§ç¦®ç›’", emoji: "ğŸ§©",
    options: [
      [{ denom: 1000, count: 8 }, { denom: 100, count: 4 }, { denom: 10, count: 2 }, { denom: 1, count: 0 }], // æ­£ç¢º
      [{ denom: 100, count: 84 }, { denom: 10, count: 2 }, { denom: 1, count: 0 }],
      [{ denom: 10, count: 842 }, { denom: 1, count: 0 }],
      [{ denom: 1000, count: 7 }, { denom: 100, count: 14 }, { denom: 10, count: 2 }, { denom: 1, count: 0 }]
    ],
    correctIndex: 0
  },
  {
    price: 1937, name: "æ–‡å…·ç¦è¢‹", emoji: "âœï¸",
    options: [
      [{ denom: 1000, count: 1 }, { denom: 100, count: 9 }, { denom: 10, count: 3 }, { denom: 1, count: 7 }], // æ­£ç¢º
      [{ denom: 100, count: 19 }, { denom: 10, count: 3 }, { denom: 1, count: 7 }],
      [{ denom: 10, count: 193 }, { denom: 1, count: 7 }],
      [{ denom: 1000, count: 1 }, { denom: 100, count: 8 }, { denom: 10, count: 13 }, { denom: 1, count: 7 }]
    ],
    correctIndex: 0
  },
  {
    price: 6284, name: "ç§‘å­¸å¯¦é©—ç›’", emoji: "ğŸ§ª",
    options: [
      [{ denom: 1000, count: 6 }, { denom: 100, count: 2 }, { denom: 10, count: 8 }, { denom: 1, count: 4 }], // æ­£ç¢º
      [{ denom: 100, count: 62 }, { denom: 10, count: 8 }, { denom: 1, count: 4 }],
      [{ denom: 10, count: 628 }, { denom: 1, count: 4 }],
      [{ denom: 1000, count: 5 }, { denom: 100, count: 12 }, { denom: 10, count: 8 }, { denom: 1, count: 4 }]
    ],
    correctIndex: 0
  }
];


    const QUESTIONS_PER_GAME = 4;
    const denomOrder = [1000, 100, 10, 1];

    const questionNumberEl = document.getElementById("questionNumber");
    const priceDisplayEl = document.getElementById("priceDisplay");
    const productNameEl = document.getElementById("productName");
    const productEmojiEl = document.getElementById("productEmoji");
    const progressInfoEl = document.getElementById("progressInfo");
    const optionsGridEl = document.getElementById("optionsGrid");

    const feedbackOverlayEl = document.getElementById("feedbackOverlay");
    const feedbackIconEl = document.getElementById("feedbackIcon");
    const feedbackTextEl = document.getElementById("feedbackText");
    const feedbackSubTextEl = document.getElementById("feedbackSubText");

    const endScreenEl = document.getElementById("endScreen");
    const endTitleEl = document.getElementById("endTitle");
    const endSubtitleEl = document.getElementById("endSubtitle");
    const endScoreEl = document.getElementById("endScore");
    const restartBtn = document.getElementById("restartBtn");
    const helpBtn = document.getElementById("helpBtn");

    let gameQuestions = [];
    let totalQuestions = 0;
    let currentIndex = 0;
    let correctCount = 0;
    let locked = false;

    function playSound(isCorrect) {
      try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) return;

        const ctx = new AudioContext();
        const now = ctx.currentTime;

        function tone(freq, startOffset, duration) {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.type = "sine";
          osc.frequency.value = freq;
          osc.connect(gain);
          gain.connect(ctx.destination);

          const start = now + startOffset;
          gain.gain.setValueAtTime(0.0001, start);
          gain.gain.exponentialRampToValueAtTime(0.22, start + 0.02);
          gain.gain.exponentialRampToValueAtTime(0.0001, start + duration);

          osc.start(start);
          osc.stop(start + duration + 0.05);
        }

        if (isCorrect) {
          tone(820, 0, 0.12);
          tone(1050, 0.16, 0.12);
        } else {
          tone(360, 0, 0.16);
          tone(250, 0.18, 0.18);
        }

        setTimeout(() => ctx.close(), 650);
      } catch (e) {}
    }

    function setupNewGame() {
      const shuffledPool = shuffle(questionsPool);
      gameQuestions = shuffledPool.slice(0, Math.min(QUESTIONS_PER_GAME, shuffledPool.length));
      totalQuestions = gameQuestions.length;
      currentIndex = 0;
      correctCount = 0;
      locked = false;
      endScreenEl.classList.remove("visible");

      endTitleEl.textContent = "å…¨éƒ¨é¡Œç›®å®Œæˆ";
      endSubtitleEl.innerHTML = punctToBreaks("ä½ å·²ç¶“å­¸æœƒå¦‚ä½•ç”¨æœ€å°‘çš„éŒ¢å¹£ä»˜æ¬¾ã€‚");
      restartBtn.textContent = "å†ç©ä¸€æ¬¡";

      renderQuestion();
    }

    function normalizeOption(optionArr) {
      const map = { 1000: 0, 100: 0, 10: 0, 1: 0 };
      for (const row of optionArr) map[row.denom] = row.count;
      return map;
    }

    function renderQuestion() {
      locked = false;
      feedbackOverlayEl.classList.remove("visible");

      const q = gameQuestions[currentIndex];

      questionNumberEl.textContent = `ç¬¬ ${currentIndex + 1} é¡Œ / å…± ${totalQuestions} é¡Œ`;
      progressInfoEl.textContent = `ç­”å°é¡Œæ•¸ï¼š${correctCount} é¡Œ`;

      priceDisplayEl.innerHTML = `${formatPrice(q.price)}<span class="unit">å…ƒ</span>`;
      productNameEl.textContent = q.name;
      productEmojiEl.textContent = q.emoji;

      const optionBundles = q.options.map((opt, idx) => ({
        option: normalizeOption(opt),
        isCorrect: idx === q.correctIndex
      }));
      const shuffledOptions = shuffle(optionBundles);

      optionsGridEl.innerHTML = "";
      const letters = ["A", "B", "C", "D"];

      shuffledOptions.forEach((bundle, index) => {
        const card = document.createElement("div");
        card.className = "option-card";
        card.dataset.correct = bundle.isCorrect ? "1" : "0";

        const title = document.createElement("div");
        title.className = "option-title";
        title.textContent = `ä»˜æ¬¾æ–¹å¼ ${letters[index]}`;
        card.appendChild(title);

        const body = document.createElement("div");
        body.className = "option-body";

        denomOrder.forEach(denom => {
          const count = bundle.option[denom] ?? 0;

          const line = document.createElement("div");
          line.className = "money-line";

          const note = document.createElement("div");
          note.className = "note-icon";
          if (denom === 1000) note.classList.add("note-1000");
          else if (denom === 100) note.classList.add("note-100");
          else if (denom === 10) note.classList.add("note-10");
          else note.classList.add("note-1");
          note.textContent = `${denom} å…ƒ`;
          line.appendChild(note);

          const multi = document.createElement("div");
          multi.className = "note-multiplier";
          multi.innerHTML = `Ã— <strong>${count}</strong>`;
          line.appendChild(multi);

          body.appendChild(line);
        });

        card.appendChild(body);
        card.addEventListener("click", () => handleOptionClick(card));
        optionsGridEl.appendChild(card);
      });
    }

    function handleOptionClick(cardEl) {
      if (locked) return;

      const isCorrect = cardEl.dataset.correct === "1";
      locked = true;
      showFeedback(isCorrect);

      const cards = optionsGridEl.querySelectorAll(".option-card");
      cards.forEach(card => card.classList.add("disabled"));

      if (isCorrect) correctCount++;

      setTimeout(() => {
        if (currentIndex < totalQuestions - 1) {
          currentIndex++;
          renderQuestion();
        } else {
          showEndScreen();
        }
      }, 1200);
    }

    function showFeedback(isCorrect) {
      feedbackIconEl.textContent = isCorrect ? "âœ“" : "âœ—";
      feedbackIconEl.style.color = isCorrect ? "#16a34a" : "#dc2626";
      feedbackTextEl.textContent = isCorrect ? "ç­”å°äº†" : "å†æƒ³ä¸€æƒ³";

      const msg = isCorrect
        ? (currentIndex < totalQuestions - 1 ? "é€²å…¥ä¸‹ä¸€é¡Œã€‚" : "å³å°‡é¡¯ç¤ºçµæœã€‚")
        : "é€™å€‹ä¸æ˜¯æœ€å°‘éŒ¢å¹£çš„ä»˜æ¬¾æ–¹å¼ã€‚";
      feedbackSubTextEl.innerHTML = punctToBreaks(msg);

      feedbackOverlayEl.classList.add("visible");
      playSound(isCorrect);
    }

    function showEndScreen() {
      feedbackOverlayEl.classList.remove("visible");
      endScoreEl.textContent = `å…± ${totalQuestions} é¡Œï¼Œä½ ç­”å°äº† ${correctCount} é¡Œã€‚`;
      endScreenEl.classList.add("visible");
    }

    restartBtn.addEventListener("click", () => setupNewGame());

    /* ========= æ“ä½œèªªæ˜ ========= */
    const guideOverlay = document.getElementById("guideOverlay");
    const guideBody = document.getElementById("guideBody");
    const guideCloseBtn = document.getElementById("guideCloseBtn");
    const guidePrevBtn = document.getElementById("guidePrevBtn");
    const guideNextBtn = document.getElementById("guideNextBtn");
    const guideIndicator = document.getElementById("guideIndicator");

    let guidePage = 0;

    function demoCardsHTML() {
      const oneCard = (label) => `
        <div class="demo-card">
          <div class="demo-card-title">${label}</div>
          <div class="demo-lines">
            <div class="demo-line"><div class="demo-note b">1000</div><div class="demo-x">Ã— 3</div></div>
            <div class="demo-line"><div class="demo-note r">100</div><div class="demo-x">Ã— 1</div></div>
            <div class="demo-line"><div class="demo-note s">10</div><div class="demo-x">Ã— 5</div></div>
            <div class="demo-line"><div class="demo-note c">1</div><div class="demo-x">Ã— 2</div></div>
          </div>
        </div>
      `;
      return oneCard("ä»˜æ¬¾æ–¹å¼ A") + oneCard("ä»˜æ¬¾æ–¹å¼ B") + oneCard("ä»˜æ¬¾æ–¹å¼ C") + oneCard("ä»˜æ¬¾æ–¹å¼ D");
    }

    const guidePages = [
      () => {
        const title = "ä»˜æ¬¾å°éŠæˆ²ï¼";
        const text =
          "é€™æ˜¯ä¸€å€‹ä»˜æ¬¾çš„å°éŠæˆ²ï¼Œæ¯ä¸€é¡Œéƒ½æœƒæœ‰ä¸€å€‹æˆ‘å€‘è¦è³¼è²·çš„æ±è¥¿ï¼Œä»¥åŠé€™å€‹ç‰©å“çš„åƒ¹æ ¼ï¼Œåˆ©ç”¨ä½ çš„è°æ˜æ‰æ™ºï¼Œæ‰¾å‡ºå››ç¨®ä»˜æ¬¾æ–¹å¼ä¸­ï¼ŒéŒ¢å¹£æ•¸é‡æœ€å°‘çš„ä»˜æ¬¾æ–¹å¼å§ï¼";
        return `
          <div class="guide-inner center-page">
            <div class="guide-page-title">${title}</div>
            <div class="guide-text">${punctToBreaks(text)}</div>
          </div>
        `;
      },

      () => `
        <div class="guide-inner">
          <div class="guide-page-title">å…ˆçœ‹å·¦é‚Š</div>
          <div class="guide-text">${punctToBreaks("å·¦é‚Šæœƒé¡¯ç¤ºé€™ä¸€é¡Œè¦è²·çš„æ±è¥¿å’Œåƒ¹æ ¼ï¼Œä½ è¦ç”¨å³é‚Šçš„å››ç¨®ä»˜æ¬¾æ–¹å¼ï¼Œæ‰¾åˆ°éŒ¢å¹£æ•¸é‡æœ€å°‘çš„é‚£ä¸€ç¨®ã€‚")}</div>

          <div class="demo-wrap">
            <div class="demo" data-demo="p2">
              <div class="demo-left">
                <div class="demo-q">ç¬¬ 1 é¡Œ / å…± 4 é¡Œ</div>
                <div class="demo-progress">ç­”å°é¡Œæ•¸ï¼š0 é¡Œ</div>

                <div class="p2-target-leftinfo" style="display:flex; flex-direction:column; gap:10px; flex:1;">
                  <div class="demo-product-image">
                    <div class="demo-emoji">ğŸ§¸</div>
                  </div>
                  <div class="demo-question-header">
                    <div class="demo-price">3152 å…ƒ</div>
                    <div class="demo-name">å°ç†Šç©å¶</div>
                  </div>
                </div>

                <div class="demo-help">æ“ä½œèªªæ˜</div>
              </div>

              <div class="demo-right">${demoCardsHTML()}</div>

              <div class="callout-box" data-target=".p2-target-leftinfo" data-label="é€™é¡Œè¦è²·çš„æ±è¥¿å’Œåƒ¹æ ¼"></div>
            </div>
          </div>
        </div>
      `,

      () => `
        <div class="guide-inner">
          <div class="guide-page-title">å†çœ‹å³é‚Š</div>
          <div class="guide-text">${punctToBreaks("å³é‚Šæœ‰å››ç¨®ä»˜æ¬¾æ–¹å¼ï¼Œä½ åªè¦é»é¸ä½ è¦ºå¾—éŒ¢å¹£æ•¸é‡æœ€å°‘çš„é‚£ä¸€æ ¼ï¼Œå°±å®Œæˆä½œç­”ã€‚")}</div>

          <div class="demo-wrap">
            <div class="demo" data-demo="p3">
              <div class="demo-left">
                <div class="demo-q">ç¬¬ 1 é¡Œ / å…± 4 é¡Œ</div>
                <div class="demo-progress">ç­”å°é¡Œæ•¸ï¼š0 é¡Œ</div>

                <div style="display:flex; flex-direction:column; gap:10px; flex:1;">
                  <div class="demo-product-image">
                    <div class="demo-emoji">ğŸ§±</div>
                  </div>
                  <div class="demo-question-header">
                    <div class="demo-price">2321 å…ƒ</div>
                    <div class="demo-name">ç©æœ¨çµ„åˆ</div>
                  </div>
                </div>

                <div class="demo-help">æ“ä½œèªªæ˜</div>
              </div>

              <div class="demo-right p3-target-rightarea">${demoCardsHTML()}</div>

              <div class="callout-box" data-target=".p3-target-rightarea" data-label="é»é¸ä¸€æ ¼ä»˜æ¬¾æ–¹å¼"></div>
            </div>
          </div>
        </div>
      `,

      () => `
        <div class="guide-inner">
          <div class="guide-page-title">ç­”å°æˆ–ç­”éŒ¯æœƒæ€æ¨£</div>
          <div class="guide-text">${punctToBreaks("ç•¶ä½ é»é¸ä»˜æ¬¾æ–¹å¼å¾Œï¼Œæœƒå‡ºç¾ç­”å°æˆ–ç­”éŒ¯çš„æç¤ºï¼Œç­”å°æœƒé€²å…¥ä¸‹ä¸€é¡Œï¼Œç­”éŒ¯æœƒæé†’ä½ å†æƒ³æƒ³ã€‚")}</div>

          <div class="feedback-samples">
            <div class="feedback-sample">
              <div class="icon" style="color:#16a34a;">âœ“</div>
              <div class="title">ç­”å°äº†</div>
              <div class="sub">${punctToBreaks("ä½ é¸åˆ°éŒ¢å¹£æ•¸é‡æœ€å°‘çš„ä»˜æ¬¾æ–¹å¼ã€‚")}</div>
            </div>

            <div class="feedback-sample">
              <div class="icon" style="color:#dc2626;">âœ—</div>
              <div class="title">å†æƒ³ä¸€æƒ³</div>
              <div class="sub">${punctToBreaks("é€™å€‹ä¸æ˜¯æœ€å°‘éŒ¢å¹£çš„ä»˜æ¬¾æ–¹å¼ã€‚")}</div>
            </div>
          </div>
        </div>
      `
    ];

    function openGuide() {
      guidePage = 0;
      renderGuidePage();
      guideOverlay.classList.add("visible");
      guideOverlay.setAttribute("aria-hidden", "false");
    }

    function closeGuide() {
      guideOverlay.classList.remove("visible");
      guideOverlay.setAttribute("aria-hidden", "true");
    }

    function renderGuidePage() {
      guideBody.scrollTop = 0; // âœ… æ›é å›åˆ°æœ€ä¸Šé¢ï¼Œé¿å…ä¸Šä¸€é æ»¾å‹•ä½ç½®å½±éŸ¿
      guideBody.innerHTML = guidePages[guidePage]();
      guideIndicator.textContent = `${guidePage + 1} / ${guidePages.length}`;

      guidePrevBtn.disabled = guidePage === 0;
      guidePrevBtn.style.opacity = guidePrevBtn.disabled ? "0.55" : "1";
      guidePrevBtn.style.cursor = guidePrevBtn.disabled ? "not-allowed" : "pointer";

      guideNextBtn.textContent = (guidePage === guidePages.length - 1) ? "é–‹å§‹éŠæˆ²" : "ä¸‹ä¸€é ";

      requestAnimationFrame(() => placeAllCallouts());
    }

    function placeAllCallouts() {
      const demos = guideBody.querySelectorAll(".demo");
      demos.forEach(demo => {
        const demoRect = demo.getBoundingClientRect();
        const boxes = demo.querySelectorAll(".callout-box[data-target]");
        boxes.forEach(box => {
          const selector = box.getAttribute("data-target");
          const labelText = box.getAttribute("data-label") || "";
          const target = demo.querySelector(selector);
          if (!target) return;

          const tRect = target.getBoundingClientRect();
          const pad = 8;

          let left = (tRect.left - demoRect.left) - pad;
          let top  = (tRect.top  - demoRect.top)  - pad;
          let width  = tRect.width + pad * 2;
          let height = tRect.height + pad * 2;

          const minInset = 8;
          const maxW = demoRect.width - minInset * 2;
          const maxH = demoRect.height - minInset * 2;

          width = Math.min(maxW, width);
          height = Math.min(maxH, height);

          left = Math.max(minInset, Math.min(left, demoRect.width - minInset - width));
          top  = Math.max(minInset, Math.min(top, demoRect.height - minInset - height));

          box.style.left = `${left}px`;
          box.style.top = `${top}px`;
          box.style.width = `${width}px`;
          box.style.height = `${height}px`;

          let label = box.querySelector(".callout-label");
          if (!label) {
            label = document.createElement("div");
            label.className = "callout-label";
            box.appendChild(label);
          }
          label.textContent = labelText;
        });
      });
    }

    guideCloseBtn.addEventListener("click", closeGuide);
    guideOverlay.addEventListener("click", (e) => { if (e.target === guideOverlay) closeGuide(); });
    guidePrevBtn.addEventListener("click", () => { if (guidePage > 0) { guidePage--; renderGuidePage(); } });
    guideNextBtn.addEventListener("click", () => {
      if (guidePage < guidePages.length - 1) { guidePage++; renderGuidePage(); }
      else { closeGuide(); }
    });

    helpBtn.addEventListener("click", () => openGuide());

    window.addEventListener("DOMContentLoaded", () => {
      setupNewGame();
      openGuide();
    });

    window.addEventListener("resize", () => {
      if (guideOverlay.classList.contains("visible")) placeAllCallouts();
    });

    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && guideOverlay.classList.contains("visible")) closeGuide();
    });
  </script>
</body>
</html>
